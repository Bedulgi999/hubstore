<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>í—ˆë¸Œ ìŠ¤í† ì–´</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="header"></div>

  <main class="page">
    <div class="container">

      <section class="hero">
        <!-- Banner -->
        <div class="card banner" id="banner">
          <div class="banner-bg"></div>

          <!-- slides -->
          <div id="bannerSlides"></div>

          <!-- arrows -->
          <div class="banner-nav">
            <button id="prevBtn" aria-label="prev">â€¹</button>
            <button id="nextBtn" aria-label="next">â€º</button>
          </div>

          <!-- dots -->
          <div class="dots" id="dots"></div>
        </div>

        <!-- Search -->
        <div class="card pad search">
          <h3>ë¹ ë¥¸ ê²€ìƒ‰</h3>
          <div class="muted" style="font-weight:700;">ìƒí’ˆ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆì–´</div>
          <div style="margin-top:10px;">
            <input class="input" id="q" placeholder="ì˜ˆ: ëŸ¬ì‹œì•ˆë£°ë ›, RPG, ì„œë²„íŒ©" />
          </div>

          <div class="hr"></div>
          <div class="muted" style="font-weight:800;margin-bottom:10px;">ì¹´í…Œê³ ë¦¬</div>
          <div class="filters" id="categoryChips"></div>

          <div class="notice" style="margin-top:12px;">
            ğŸ’¡ íŒ: ë°°ë„ˆëŠ” ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ê³ , í™”ì‚´í‘œë¡œë„ ì´ë™ ê°€ëŠ¥í•´ìš”.
          </div>
        </div>
      </section>

      <h2 class="section-title">ì¶”ì²œ íŒë§¤ì ë¦¬ìŠ¤íŠ¸!</h2>
      <div class="grid" id="sellerGrid"></div>

      <h2 class="section-title">ìµœê³  ì¸ê¸° ìƒí’ˆ</h2>
      <div class="grid" id="productGrid"></div>

      <div class="footer">Â© 2025 í—ˆë¸Œ ìŠ¤í† ì–´ Â· Supabase + Static</div>
    </div>
  </main>

  <script type="module">
    import { renderHeader, enableHeaderAutoRefresh } from "/header.js";
    import { supabase } from "/supabase.js";

    await renderHeader();
    enableHeaderAutoRefresh();

    // ---------- Data loaders ----------
    async function loadBanners() {
      // banners: (id, title, subtitle, cta_label, cta_url, is_active, sort_order)
      const { data, error } = await supabase
        .from("banners")
        .select("*")
        .eq("is_active", true)
        .order("sort_order", { ascending: true })
        .limit(6);

      if (error) {
        console.warn("banners load error:", error.message);
        return [
          { title:"ë°°ë„ˆ1", subtitle:"ì¸ê¸° ë¯¸ë‹ˆê²Œì„ íŒ© í• ì¸!", cta_label:"ë°”ë¡œê°€ê¸°", cta_url:"#"},
          { title:"ë°°ë„ˆ2", subtitle:"ì‹ ê·œ ì„œë²„íŒ© ì¶œì‹œ", cta_label:"ì „ì²´ ìƒí’ˆ", cta_url:"#"},
          { title:"ë°°ë„ˆ3", subtitle:"ê³µì‹ ì´ë²¤íŠ¸ ì•ˆë‚´", cta_label:"ê³µì§€/ì´ë²¤íŠ¸", cta_url:"#"},
        ];
      }
      return (data?.length ? data : []);
    }

    async function loadCategories() {
      // categories: (id, name, sort_order, is_active)
      const { data, error } = await supabase
        .from("categories")
        .select("*")
        .eq("is_active", true)
        .order("sort_order", { ascending: true });

      if (error) {
        console.warn("categories load error:", error.message);
        return ["ì „ì²´", "ë¯¸ë‹ˆê²Œì„", "ì„œë²„íŒ©"];
      }
      return ["ì „ì²´", ...(data || []).map(x => x.name)];
    }

    async function loadSellers() {
      // sellers: (id, display_name, tagline, is_verified, badge_recommended, avatar_url)
      const { data, error } = await supabase
        .from("sellers")
        .select("*")
        .order("badge_recommended", { ascending: false })
        .limit(6);

      if (error) {
        console.warn("sellers load error:", error.message);
        return [];
      }
      return data || [];
    }

    async function loadProducts({ q = "", category = "ì „ì²´" } = {}) {
      // products: (id, title, price, seller_name(or join), is_published, category, cover_url)
      let query = supabase
        .from("products")
        .select("*")
        .eq("is_published", true)
        .order("created_at", { ascending: false })
        .limit(12);

      if (q?.trim()) query = query.ilike("title", `%${q.trim()}%`);
      if (category && category !== "ì „ì²´") query = query.eq("category", category);

      const { data, error } = await query;
      if (error) {
        console.warn("products load error:", error.message);
        return [];
      }
      return data || [];
    }

    // ---------- UI renderers ----------
    function renderSellers(list) {
      const el = document.getElementById("sellerGrid");
      if (!list.length) {
        el.innerHTML = `<div class="muted" style="font-weight:800;">íŒë§¤ìê°€ ì•„ì§ ì—†ì–´ìš”. (adminì—ì„œ sellers ë°ì´í„° ë¨¼ì € ë„£ì–´ì¤˜)</div>`;
        return;
      }
      el.innerHTML = list.map(s => `
        <div class="card item">
          <div class="thumb"></div>
          <div class="body">
            <div class="name">${escapeHtml(s.display_name || "Seller")}</div>
            <div class="sub">${escapeHtml(s.tagline || "")}</div>
          </div>
        </div>
      `).join("");
    }

    function renderProducts(list) {
      const el = document.getElementById("productGrid");
      if (!list.length) {
        el.innerHTML = `<div class="muted" style="font-weight:800;">ìƒí’ˆì´ ì•„ì§ ì—†ì–´ìš”. (adminì—ì„œ products ë“±ë¡í•´ì¤˜)</div>`;
        return;
      }
      el.innerHTML = list.map(p => `
        <div class="card item">
          <div class="thumb"></div>
          <div class="body">
            <div class="name">${escapeHtml(p.title || "Product")}</div>
            <div class="sub">${escapeHtml(p.category || "")} Â· ${formatPrice(p.price)}</div>
          </div>
        </div>
      `).join("");
    }

    function escapeHtml(s){
      return (s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }
    function formatPrice(n){
      const v = Number(n || 0);
      return v.toLocaleString("ko-KR") + "ì›";
    }

    // ---------- Banner carousel ----------
    let banners = [];
    let idx = 0;
    let timer = null;

    function renderBanners() {
      const slides = document.getElementById("bannerSlides");
      const dots = document.getElementById("dots");

      if (!banners.length) {
        slides.innerHTML = `
          <div class="banner-slide active">
            <div class="banner-content">
              <span class="badge">EVENT</span>
              <div class="banner-title">ë°°ë„ˆ ì—†ìŒ</div>
              <div class="banner-sub">adminì—ì„œ bannersë¥¼ ì¶”ê°€í•´ì¤˜</div>
              <div class="banner-actions">
                <a class="btn primary" href="/admin.html">ê´€ë¦¬ì ì—´ê¸°</a>
              </div>
            </div>
          </div>
        `;
        dots.innerHTML = "";
        return;
      }

      slides.innerHTML = banners.map((b, i) => `
        <div class="banner-slide ${i === idx ? "active" : ""}">
          <div class="banner-content">
            <span class="badge">EVENT</span>
            <div class="banner-title">${escapeHtml(b.title || `ë°°ë„ˆ${i+1}`)}</div>
            <div class="banner-sub">${escapeHtml(b.subtitle || "")}</div>
            <div class="banner-actions">
              <a class="btn primary" href="${escapeHtml(b.cta_url || "#")}">${escapeHtml(b.cta_label || "ë°”ë¡œê°€ê¸°")}</a>
              <a class="btn" href="/index.html">ì „ì²´ ìƒí’ˆ</a>
            </div>
          </div>
        </div>
      `).join("");

      dots.innerHTML = banners.map((_, i) => `
        <div class="dot ${i===idx ? "active":""}" data-i="${i}"></div>
      `).join("");

      dots.querySelectorAll(".dot").forEach(d => {
        d.addEventListener("click", () => {
          idx = Number(d.dataset.i);
          renderBanners();
          restartAuto();
        });
      });
    }

    function next() {
      if (!banners.length) return;
      idx = (idx + 1) % banners.length;
      renderBanners();
    }
    function prev() {
      if (!banners.length) return;
      idx = (idx - 1 + banners.length) % banners.length;
      renderBanners();
    }
    function restartAuto() {
      if (timer) clearInterval(timer);
      timer = setInterval(next, 4500);
    }

    document.getElementById("nextBtn").addEventListener("click", () => { next(); restartAuto(); });
    document.getElementById("prevBtn").addEventListener("click", () => { prev(); restartAuto(); });

    // ---------- Category filters + search ----------
    let currentCategory = "ì „ì²´";
    let currentQ = "";

    function renderCategoryChips(list) {
      const el = document.getElementById("categoryChips");
      el.innerHTML = list.map(name => `
        <button class="pill ${name===currentCategory ? "active":""}" data-name="${escapeHtml(name)}">${escapeHtml(name)}</button>
      `).join("");
      el.querySelectorAll(".pill").forEach(btn => {
        btn.addEventListener("click", async () => {
          currentCategory = btn.dataset.name;
          renderCategoryChips(list);
          const items = await loadProducts({ q: currentQ, category: currentCategory });
          renderProducts(items);
        });
      });
    }

    document.getElementById("q").addEventListener("input", async (e) => {
      currentQ = e.target.value || "";
      const items = await loadProducts({ q: currentQ, category: currentCategory });
      renderProducts(items);
    });

    // ---------- Boot ----------
    banners = await loadBanners();
    idx = 0;
    renderBanners();
    restartAuto();

    const cats = await loadCategories();
    renderCategoryChips(cats);

    renderSellers(await loadSellers());
    renderProducts(await loadProducts({ q: "", category: "ì „ì²´" }));
  </script>
</body>
</html>
